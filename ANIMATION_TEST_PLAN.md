# Animation System Test Plan

## Test Environment Setup
1. Have at least 2-3 test services in different states (confirmed, helpr_otw, in_progress, completed)
2. Enable console logging in both apps
3. Have both customer and provider apps running

## Critical Test Cases

### üéØ Test 1: Navigation from Landing (NEW SERVICE)
**Purpose**: Verify animation shows correct frame immediately when opening service from card

**Steps**:
1. Open provider app landing page
2. Note status of a service card (e.g., "Helpr OTW")
3. Tap the service card to open ServiceDetails
4. Observe animation

**Expected Result**:
- ‚úÖ Animation appears at correct frame instantly (no jump)
- ‚úÖ Console shows: `üé¨ Animation effect: { isNewService: true, ... }`
- ‚úÖ Console shows: `‚ú® New service detected, jumping to frame: X`
- ‚úÖ Animation matches service status shown on card

**Common Failure**: Animation starts at frame 0 then jumps to correct frame
**If Failed**: Check that `setTimeout` delay is working and key prop is set

---

### üîÑ Test 2: Status Update (SAME SERVICE)
**Purpose**: Verify smooth animation when service status changes via button

**Steps**:
1. Open a service in "Confirmed" state (frame 0)
2. Tap the status action button (e.g., "On The Way")
3. Observe animation

**Expected Result**:
- ‚úÖ Animation smoothly transitions from frame 0 ‚Üí 20
- ‚úÖ Console shows: `üé¨ Animation effect: { statusChanged: true, ... }`
- ‚úÖ Console shows: `‚ñ∂Ô∏è Status changed, animating from 0 to 20`
- ‚úÖ No jumping or snapping
- ‚úÖ Animation completes at correct frame

**Common Failure**: Animation jumps instead of smooth transition
**If Failed**: Check `animateToFrame` logic and `isAnimatingRef` flag

---

### üîÄ Test 3: Switching Between Services
**Purpose**: Verify each service maintains independent animation state

**Steps**:
1. Open Service A (status: "In Progress" - frame 50)
2. Verify animation is at frame 50
3. Go back to landing
4. Open Service B (status: "Confirmed" - frame 0)
5. Verify animation is at frame 0
6. Go back to landing
7. Open Service A again
8. Verify animation is still at frame 50

**Expected Result**:
- ‚úÖ Service B shows frame 0 (not frame 50 from Service A)
- ‚úÖ Console shows `üßπ Cleaning up animation state` when navigating away
- ‚úÖ Each service displays its own status correctly
- ‚úÖ No state bleeding between services

**Common Failure**: Service B shows Service A's animation state
**If Failed**: Check cleanup effect and `currentServiceIdRef` reset

---

### üì° Test 4: Real-time Update (SUPABASE)
**Purpose**: Verify animation updates when status changes in database

**Steps**:
1. Open ServiceDetails in provider app (status: "Confirmed")
2. Keep the screen open
3. Use another device/Supabase dashboard to update the service status to "Helpr_OTW"
4. Observe animation (should update within ~2 seconds due to polling)

**Expected Result**:
- ‚úÖ Animation smoothly transitions to new status
- ‚úÖ Console shows real-time update logs
- ‚úÖ Animation doesn't jump or reset
- ‚úÖ Final frame matches new status

**Common Failure**: Animation doesn't update or jumps
**If Failed**: Check Supabase subscription and `fetchServiceData` triggering

---

### üîÅ Test 5: Component Re-render (SAME STATUS)
**Purpose**: Verify animation stays stable during React re-renders

**Steps**:
1. Open ServiceDetails (status: "In Progress" - frame 50)
2. Trigger a re-render by:
   - Opening/closing a modal (e.g., rating modal if service is complete)
   - Rotating device (if mobile)
   - Any action that causes re-render without status change
3. Observe animation

**Expected Result**:
- ‚úÖ Animation stays at frame 50
- ‚úÖ Console shows: `üîÑ Same status, ensuring correct frame: 50`
- ‚úÖ No visible jump or reset
- ‚úÖ Animation remains stable

**Common Failure**: Animation resets to frame 0 on re-render
**If Failed**: Check `statusChanged` condition and `setFrameImmediate` logic

---

### üîÑ Test 6: App Restart (PERSISTENCE)
**Purpose**: Verify animation shows correct frame after app restart

**Steps**:
1. Note a service status (e.g., "Helpr OTW")
2. Close app completely (force quit)
3. Reopen app
4. Navigate to that service's ServiceDetails
5. Observe animation

**Expected Result**:
- ‚úÖ Animation loads at correct frame for status
- ‚úÖ No transition animation on initial load
- ‚úÖ Console shows: `‚ú® New service detected`
- ‚úÖ Matches service status from database

**Common Failure**: Animation shows wrong frame on cold start
**If Failed**: Check that service data is fetched before animation effect runs

---

### ‚ö° Test 7: Rapid Status Changes
**Purpose**: Verify system handles multiple quick status updates

**Steps**:
1. Open ServiceDetails (status: "Confirmed" - frame 0)
2. Quickly tap status button to trigger update
3. While animation is playing, manually update status again in database
4. Observe animation

**Expected Result**:
- ‚úÖ Animation handles conflicting updates gracefully
- ‚úÖ `isAnimatingRef` prevents double-animation
- ‚úÖ Final frame matches final status
- ‚úÖ No visual glitches or stuck animations

**Common Failure**: Animation gets stuck or shows wrong frame
**If Failed**: Check `isAnimatingRef` logic and timeout cleanup

---

### üîô Test 8: Backward Status Change (EDGE CASE)
**Purpose**: Verify animation handles status regression (shouldn't happen in production)

**Steps**:
1. Open ServiceDetails (status: "In Progress" - frame 50)
2. Manually set status to "Confirmed" in database (frame 0)
3. Wait for real-time update
4. Observe animation

**Expected Result**:
- ‚úÖ Animation jumps to frame 0 (no backward animation)
- ‚úÖ Console may show warning about backward transition
- ‚úÖ Animation settles at correct frame
- ‚úÖ No infinite loop or crashes

**Common Failure**: System tries to animate backwards
**If Failed**: Check `startFrame >= endFrame` condition in `animateToFrame`

---

## Console Log Checklist

For each test, verify you see appropriate console logs:

### On New Service Navigation:
```
üé¨ Animation effect: { serviceId: '...', status: '...', isNewService: true, ... }
‚ú® New service detected, jumping to frame: X
```

### On Status Change:
```
üé¨ Animation effect: { serviceId: '...', status: '...', statusChanged: true, ... }
‚ñ∂Ô∏è Status changed, animating from X to Y
```

### On Re-render (Same Status):
```
üé¨ Animation effect: { serviceId: '...', status: '...', statusChanged: false, ... }
üîÑ Same status, ensuring correct frame: X
```

### On Navigation Away:
```
üßπ Cleaning up animation state
```

## Edge Cases to Watch For

1. **Null/Undefined Status**: Should not crash, should default to frame 0
2. **Invalid Service ID**: Should not render animation
3. **Animation Ref Not Ready**: Should handle gracefully with early return
4. **Concurrent Status Updates**: Should queue properly
5. **Network Delays**: Should show last known frame until update arrives

## Performance Checks

- ‚úÖ No memory leaks when navigating between services
- ‚úÖ Smooth 60fps animation transitions
- ‚úÖ No janky UI during status updates
- ‚úÖ Refs don't cause unnecessary re-renders

## Debugging Tips

### Animation Not Updating:
1. Check console for `üé¨ Animation effect` logs
2. Verify `service?.status` and `service?.service_id` are present
3. Check `animationRef.current` is not null
4. Verify Lottie component has correct `key` prop

### Animation Jumping:
1. Check if `isNewService` is incorrectly triggering
2. Verify `currentServiceIdRef` is updating correctly
3. Look for multiple rapid effect executions
4. Check if cleanup effect is running unexpectedly

### Animation Stuck:
1. Check `isAnimatingRef` value
2. Verify timeout is clearing properly
3. Look for errors in console
4. Check if `goToAndStop` is available

## Success Criteria

All tests must pass with:
- ‚úÖ No visual jumps or glitches
- ‚úÖ Correct console logs for each scenario
- ‚úÖ Smooth animations where expected
- ‚úÖ Instant positioning where expected
- ‚úÖ No errors in console
- ‚úÖ Proper cleanup on unmount

## Customer App Testing

Repeat all tests in customer app (`apps/customer-app/app/ServiceDetails.tsx`):
- Should behave identically to provider app
- Same console logs
- Same smooth animations
- Same status ‚Üí frame mapping

## Sign-off

Once all tests pass:
- [ ] Provider app ServiceDetails tested
- [ ] Customer app ServiceDetails tested
- [ ] All console logs verified
- [ ] No visual glitches observed
- [ ] Performance acceptable
- [ ] Edge cases handled
- [ ] Documentation reviewed

**Tested by**: ________________  
**Date**: ________________  
**Build**: ________________
